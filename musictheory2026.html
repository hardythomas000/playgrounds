<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Theory Playground 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            padding-bottom: 20px;
        }

        header {
            background: #ffffff;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        nav {
            position: sticky;
            top: 0;
            background: #ffffff;
            border-bottom: 1px solid #d2d2d7;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            z-index: 100;
            -webkit-overflow-scrolling: touch;
        }

        nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            display: inline-block;
            padding: 15px 20px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #6e6e73;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: #0071e3;
            border-bottom-color: #0071e3;
        }

        .tab-content {
            display: none;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: #ffffff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #1d1d1f;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            background: #ffffff;
        }

        input[type="range"] {
            padding: 0;
        }

        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:active {
            background: #0077ed;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        /* Piano Styles */
        .piano-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .piano {
            position: relative;
            display: flex;
            height: 200px;
            min-width: 700px;
            user-select: none;
        }

        .key {
            position: relative;
            border: 1px solid #000;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.05s;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f8f8 100%);
            z-index: 1;
            border-radius: 0 0 4px 4px;
        }

        .white-key:active, .white-key.playing {
            background: linear-gradient(to bottom, #e3f2fd 0%, #bbdefb 100%);
        }

        .black-key {
            width: 30px;
            height: 120px;
            background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
            z-index: 2;
            position: absolute;
            color: #ffffff;
            border-radius: 0 0 3px 3px;
        }

        .black-key:active, .black-key.playing {
            background: linear-gradient(to bottom, #1976d2 0%, #0d47a1 100%);
        }

        /* Chord Explorer */
        .mini-piano {
            display: flex;
            height: 120px;
            margin: 20px 0;
            position: relative;
        }

        .mini-key {
            position: relative;
            border: 1px solid #000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-size: 9px;
            padding-bottom: 5px;
        }

        .mini-white-key {
            width: 30px;
            height: 120px;
            background: #ffffff;
            z-index: 1;
        }

        .mini-black-key {
            width: 18px;
            height: 75px;
            background: #000000;
            color: #ffffff;
            z-index: 2;
            position: absolute;
        }

        .mini-key.highlighted {
            background: #4caf50 !important;
        }

        .chord-info {
            background: #f0f0f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .chord-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Scale Visualizer */
        .circle-of-fifths {
            width: 280px;
            height: 280px;
            margin: 20px auto;
            position: relative;
        }

        .circle-note {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #d2d2d7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .circle-note.in-scale {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
            transform: scale(1.15);
        }

        /* Rhythm Machine */
        .beat-display {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .beat-indicator {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.1s;
        }

        .beat-indicator.active {
            background: #0071e3;
            color: white;
            transform: scale(1.2);
        }

        .beat-indicator.accent {
            border: 3px solid #ff9800;
        }

        .bpm-display {
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            color: #0071e3;
            margin: 20px 0;
        }

        /* Interval Trainer */
        .game-area {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }

        .score {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #4caf50;
        }

        .interval-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .interval-btn {
            background: #f0f0f5;
            color: #1d1d1f;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .interval-btn:active {
            transform: scale(0.95);
        }

        .interval-btn.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .interval-btn.incorrect {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .feedback {
            margin-top: 20px;
            font-size: 18px;
            font-weight: 600;
            min-height: 30px;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
            color: #0071e3;
        }
    </style>
</head>
<body>
    <header>
        <h1>Music Theory Playground 2026</h1>
    </header>

    <nav>
        <button class="tab-btn active" data-tab="piano">Piano</button>
        <button class="tab-btn" data-tab="chord">Chord Explorer</button>
        <button class="tab-btn" data-tab="scale">Scale Visualizer</button>
        <button class="tab-btn" data-tab="rhythm">Rhythm Machine</button>
        <button class="tab-btn" data-tab="interval">Interval Trainer</button>
    </nav>

    <!-- Piano Tab -->
    <div class="tab-content active" id="piano">
        <div class="controls">
            <div class="control-group">
                <label for="waveform">Waveform</label>
                <select id="waveform">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div class="control-group">
                <label for="octave">Octave Range</label>
                <select id="octave">
                    <option value="3">C3-B4</option>
                    <option value="4" selected>C4-B5</option>
                    <option value="5">C5-B6</option>
                </select>
            </div>
            <div class="control-group checkbox-group">
                <input type="checkbox" id="sustain">
                <label for="sustain" style="margin: 0;">Sustain</label>
            </div>
            <div class="control-group checkbox-group">
                <input type="checkbox" id="show-labels" checked>
                <label for="show-labels" style="margin: 0;">Show Note Labels</label>
            </div>
        </div>
        <div class="piano-container">
            <div class="piano" id="piano-keyboard"></div>
        </div>
    </div>

    <!-- Chord Explorer Tab -->
    <div class="tab-content" id="chord">
        <div class="controls">
            <div class="control-group">
                <label for="chord-root">Root Note</label>
                <select id="chord-root">
                    <option value="C">C</option>
                    <option value="C#">C#</option>
                    <option value="D">D</option>
                    <option value="D#">D#</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F#</option>
                    <option value="G">G</option>
                    <option value="G#">G#</option>
                    <option value="A">A</option>
                    <option value="A#">A#</option>
                    <option value="B">B</option>
                </select>
            </div>
            <div class="control-group">
                <label for="chord-type">Chord Type</label>
                <select id="chord-type">
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                    <option value="7th">Dominant 7th</option>
                    <option value="maj7">Major 7th</option>
                    <option value="dim">Diminished</option>
                    <option value="aug">Augmented</option>
                    <option value="sus2">Sus2</option>
                    <option value="sus4">Sus4</option>
                </select>
            </div>
            <button id="play-chord">Play Chord</button>
        </div>
        <div class="mini-piano" id="chord-piano"></div>
        <div class="chord-info" id="chord-info"></div>
    </div>

    <!-- Scale Visualizer Tab -->
    <div class="tab-content" id="scale">
        <div class="controls">
            <div class="control-group">
                <label for="scale-key">Key</label>
                <select id="scale-key">
                    <option value="C">C</option>
                    <option value="C#">C#</option>
                    <option value="D">D</option>
                    <option value="D#">D#</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F#</option>
                    <option value="G">G</option>
                    <option value="G#">G#</option>
                    <option value="A">A</option>
                    <option value="A#">A#</option>
                    <option value="B">B</option>
                </select>
            </div>
            <div class="control-group">
                <label for="scale-type">Scale</label>
                <select id="scale-type">
                    <option value="major">Major</option>
                    <option value="minor">Natural Minor</option>
                    <option value="pentatonic">Pentatonic Major</option>
                    <option value="blues">Blues</option>
                    <option value="dorian">Dorian</option>
                    <option value="mixolydian">Mixolydian</option>
                </select>
            </div>
            <button id="play-scale">Play Scale</button>
        </div>
        <div class="mini-piano" id="scale-piano"></div>
        <div class="circle-of-fifths" id="circle-of-fifths"></div>
    </div>

    <!-- Rhythm Machine Tab -->
    <div class="tab-content" id="rhythm">
        <div class="controls">
            <div class="control-group">
                <label for="bpm">BPM: <span class="range-value" id="bpm-value">120</span></label>
                <input type="range" id="bpm" min="40" max="200" value="120">
            </div>
            <div class="control-group">
                <label for="time-sig">Time Signature</label>
                <select id="time-sig">
                    <option value="4/4" selected>4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="6/8">6/8</option>
                </select>
            </div>
            <div class="control-group">
                <label for="click-sound">Click Sound</label>
                <select id="click-sound">
                    <option value="woodblock">Woodblock</option>
                    <option value="beep">Beep</option>
                    <option value="click">Click</option>
                </select>
            </div>
            <button id="start-metronome">Start</button>
        </div>
        <div class="bpm-display" id="bpm-display">120</div>
        <div class="beat-display" id="beat-display"></div>
    </div>

    <!-- Interval Trainer Tab -->
    <div class="tab-content" id="interval">
        <div class="controls">
            <div class="control-group">
                <label for="difficulty">Difficulty</label>
                <select id="difficulty">
                    <option value="easy">Easy (Small Intervals)</option>
                    <option value="all">All Intervals</option>
                </select>
            </div>
        </div>
        <div class="game-area">
            <div class="score">Score: <span id="score">0</span> / <span id="total">0</span></div>
            <button id="play-interval">Play Interval</button>
            <div class="interval-buttons" id="interval-buttons"></div>
            <div class="feedback" id="feedback"></div>
        </div>
    </div>

    <script>
        // Audio Context
        let audioContext = null;
        let currentOscillators = [];

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // Note frequencies (A4 = 440 Hz)
        const noteFrequencies = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
            'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
            'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
        };

        function getFrequency(note, octave) {
            const baseFreq = noteFrequencies[note];
            return baseFreq * Math.pow(2, octave - 4);
        }

        // Play note function
        function playNote(note, octave, duration = null, waveform = 'sine') {
            const ctx = initAudio();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.type = waveform;
            oscillator.frequency.value = getFrequency(note, octave);

            gainNode.gain.value = 0.3;
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.start();

            if (duration) {
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                oscillator.stop(ctx.currentTime + duration);
            } else {
                currentOscillators.push({ oscillator, gainNode });
            }

            return { oscillator, gainNode };
        }

        function stopNote(oscillatorObj) {
            if (oscillatorObj && oscillatorObj.oscillator) {
                const ctx = audioContext;
                oscillatorObj.gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                oscillatorObj.oscillator.stop(ctx.currentTime + 0.1);
            }
        }

        function stopAllNotes() {
            currentOscillators.forEach(osc => stopNote(osc));
            currentOscillators = [];
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                stopAllNotes();
            });
        });

        // ===== PIANO TAB =====
        const pianoNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];
        let activeKeys = new Map();

        function createPiano() {
            const keyboard = document.getElementById('piano-keyboard');
            keyboard.innerHTML = '';
            const octaveStart = parseInt(document.getElementById('octave').value);
            const showLabels = document.getElementById('show-labels').checked;

            for (let octave = octaveStart; octave < octaveStart + 2; octave++) {
                whiteNotes.forEach((note, index) => {
                    const key = document.createElement('div');
                    key.className = 'key white-key';
                    key.dataset.note = note;
                    key.dataset.octave = octave;
                    if (showLabels) {
                        key.textContent = `${note}${octave}`;
                    }

                    const handleStart = (e) => {
                        e.preventDefault();
                        initAudio();
                        const waveform = document.getElementById('waveform').value;
                        const sustain = document.getElementById('sustain').checked;
                        key.classList.add('playing');

                        if (sustain) {
                            if (!activeKeys.has(key)) {
                                const osc = playNote(note, octave, null, waveform);
                                activeKeys.set(key, osc);
                            }
                        } else {
                            playNote(note, octave, 0.5, waveform);
                        }
                    };

                    const handleEnd = (e) => {
                        e.preventDefault();
                        key.classList.remove('playing');
                        const sustain = document.getElementById('sustain').checked;
                        if (!sustain && activeKeys.has(key)) {
                            stopNote(activeKeys.get(key));
                            activeKeys.delete(key);
                        }
                    };

                    key.addEventListener('mousedown', handleStart);
                    key.addEventListener('mouseup', handleEnd);
                    key.addEventListener('mouseleave', handleEnd);
                    key.addEventListener('touchstart', handleStart);
                    key.addEventListener('touchend', handleEnd);

                    keyboard.appendChild(key);

                    // Add black key after certain white keys
                    if (note !== 'E' && note !== 'B') {
                        const blackNote = pianoNotes[pianoNotes.indexOf(note) + 1];
                        const blackKey = document.createElement('div');
                        blackKey.className = 'key black-key';
                        blackKey.dataset.note = blackNote;
                        blackKey.dataset.octave = octave;
                        blackKey.style.left = `${(index + 0.7) * 50 + (octave - octaveStart) * 350}px`;
                        if (showLabels) {
                            blackKey.textContent = `${blackNote}${octave}`;
                        }

                        const handleBlackStart = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            initAudio();
                            const waveform = document.getElementById('waveform').value;
                            const sustain = document.getElementById('sustain').checked;
                            blackKey.classList.add('playing');

                            if (sustain) {
                                if (!activeKeys.has(blackKey)) {
                                    const osc = playNote(blackNote, octave, null, waveform);
                                    activeKeys.set(blackKey, osc);
                                }
                            } else {
                                playNote(blackNote, octave, 0.5, waveform);
                            }
                        };

                        const handleBlackEnd = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            blackKey.classList.remove('playing');
                            const sustain = document.getElementById('sustain').checked;
                            if (!sustain && activeKeys.has(blackKey)) {
                                stopNote(activeKeys.get(blackKey));
                                activeKeys.delete(blackKey);
                            }
                        };

                        blackKey.addEventListener('mousedown', handleBlackStart);
                        blackKey.addEventListener('mouseup', handleBlackEnd);
                        blackKey.addEventListener('mouseleave', handleBlackEnd);
                        blackKey.addEventListener('touchstart', handleBlackStart);
                        blackKey.addEventListener('touchend', handleBlackEnd);

                        keyboard.appendChild(blackKey);
                    }
                });
            }
        }

        // Piano controls
        document.getElementById('octave').addEventListener('change', () => {
            stopAllNotes();
            activeKeys.clear();
            createPiano();
        });

        document.getElementById('show-labels').addEventListener('change', createPiano);

        document.getElementById('sustain').addEventListener('change', () => {
            if (!document.getElementById('sustain').checked) {
                activeKeys.forEach((osc, key) => {
                    stopNote(osc);
                    key.classList.remove('playing');
                });
                activeKeys.clear();
            }
        });

        // ===== CHORD EXPLORER =====
        const chordFormulas = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            '7th': [0, 4, 7, 10],
            'maj7': [0, 4, 7, 11],
            'dim': [0, 3, 6],
            'aug': [0, 4, 8],
            'sus2': [0, 2, 7],
            'sus4': [0, 5, 7]
        };

        const intervalNames = ['Root', 'minor 2nd', 'Major 2nd', 'minor 3rd', 'Major 3rd', 'Perfect 4th',
                               'Tritone', 'Perfect 5th', 'minor 6th', 'Major 6th', 'minor 7th', 'Major 7th'];

        function createMiniPiano(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            whiteNotes.forEach((note, index) => {
                const key = document.createElement('div');
                key.className = 'mini-key mini-white-key';
                key.dataset.note = note;
                container.appendChild(key);

                if (note !== 'E' && note !== 'B') {
                    const blackNote = pianoNotes[pianoNotes.indexOf(note) + 1];
                    const blackKey = document.createElement('div');
                    blackKey.className = 'mini-key mini-black-key';
                    blackKey.dataset.note = blackNote;
                    blackKey.style.left = `${(index + 0.7) * 30}px`;
                    container.appendChild(blackKey);
                }
            });
        }

        function updateChord() {
            const root = document.getElementById('chord-root').value;
            const type = document.getElementById('chord-type').value;
            const formula = chordFormulas[type];

            const rootIndex = pianoNotes.indexOf(root);
            const chordNotes = formula.map(interval => pianoNotes[(rootIndex + interval) % 12]);

            // Highlight notes
            document.querySelectorAll('#chord-piano .mini-key').forEach(key => {
                key.classList.remove('highlighted');
                if (chordNotes.includes(key.dataset.note)) {
                    key.classList.add('highlighted');
                }
            });

            // Show chord info
            const intervals = formula.map(f => intervalNames[f]).join(', ');
            document.getElementById('chord-info').innerHTML = `
                <p><strong>Chord:</strong> ${root} ${type}</p>
                <p><strong>Notes:</strong> ${chordNotes.join(', ')}</p>
                <p><strong>Intervals:</strong> ${intervals}</p>
            `;
        }

        document.getElementById('chord-root').addEventListener('change', updateChord);
        document.getElementById('chord-type').addEventListener('change', updateChord);

        document.getElementById('play-chord').addEventListener('click', () => {
            initAudio();
            const root = document.getElementById('chord-root').value;
            const type = document.getElementById('chord-type').value;
            const formula = chordFormulas[type];
            const rootIndex = pianoNotes.indexOf(root);

            formula.forEach((interval, i) => {
                const note = pianoNotes[(rootIndex + interval) % 12];
                const octave = 4 + Math.floor((rootIndex + interval) / 12);
                setTimeout(() => playNote(note, octave, 2), i * 50);
            });
        });

        // ===== SCALE VISUALIZER =====
        const scaleFormulas = {
            'major': [0, 2, 4, 5, 7, 9, 11],
            'minor': [0, 2, 3, 5, 7, 8, 10],
            'pentatonic': [0, 2, 4, 7, 9],
            'blues': [0, 3, 5, 6, 7, 10],
            'dorian': [0, 2, 3, 5, 7, 9, 10],
            'mixolydian': [0, 2, 4, 5, 7, 9, 10]
        };

        function createCircleOfFifths() {
            const container = document.getElementById('circle-of-fifths');
            container.innerHTML = '';
            const circleNotes = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'G#', 'D#', 'A#', 'F'];
            const radius = 120;
            const centerX = 140;
            const centerY = 140;

            circleNotes.forEach((note, i) => {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const noteDiv = document.createElement('div');
                noteDiv.className = 'circle-note';
                noteDiv.textContent = note;
                noteDiv.style.left = `${x - 20}px`;
                noteDiv.style.top = `${y - 20}px`;
                noteDiv.dataset.note = note;
                container.appendChild(noteDiv);
            });
        }

        function updateScale() {
            const key = document.getElementById('scale-key').value;
            const type = document.getElementById('scale-type').value;
            const formula = scaleFormulas[type];

            const keyIndex = pianoNotes.indexOf(key);
            const scaleNotes = formula.map(interval => pianoNotes[(keyIndex + interval) % 12]);

            // Highlight piano
            document.querySelectorAll('#scale-piano .mini-key').forEach(k => {
                k.classList.remove('highlighted');
                if (scaleNotes.includes(k.dataset.note)) {
                    k.classList.add('highlighted');
                }
            });

            // Highlight circle
            document.querySelectorAll('.circle-note').forEach(n => {
                n.classList.remove('in-scale');
                if (scaleNotes.includes(n.dataset.note)) {
                    n.classList.add('in-scale');
                }
            });
        }

        document.getElementById('scale-key').addEventListener('change', updateScale);
        document.getElementById('scale-type').addEventListener('change', updateScale);

        document.getElementById('play-scale').addEventListener('click', () => {
            initAudio();
            const key = document.getElementById('scale-key').value;
            const type = document.getElementById('scale-type').value;
            const formula = scaleFormulas[type];
            const keyIndex = pianoNotes.indexOf(key);

            formula.forEach((interval, i) => {
                const note = pianoNotes[(keyIndex + interval) % 12];
                const octave = 4 + Math.floor((keyIndex + interval) / 12);
                setTimeout(() => playNote(note, octave, 0.5), i * 300);
            });
        });

        // ===== RHYTHM MACHINE =====
        let metronomeInterval = null;
        let currentBeat = 0;

        function createBeatDisplay() {
            const timeSig = document.getElementById('time-sig').value;
            const beats = parseInt(timeSig.split('/')[0]);
            const display = document.getElementById('beat-display');
            display.innerHTML = '';

            for (let i = 0; i < beats; i++) {
                const beat = document.createElement('div');
                beat.className = 'beat-indicator';
                if (i === 0) beat.classList.add('accent');
                beat.textContent = i + 1;
                beat.dataset.beat = i;
                display.appendChild(beat);
            }
        }

        function playClick(isAccent = false) {
            const ctx = initAudio();
            const clickSound = document.getElementById('click-sound').value;

            if (clickSound === 'woodblock') {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.frequency.value = isAccent ? 1200 : 800;
                gain.gain.value = isAccent ? 0.5 : 0.3;
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } else if (clickSound === 'beep') {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.frequency.value = isAccent ? 880 : 440;
                gain.gain.value = isAccent ? 0.4 : 0.2;
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.15);
            } else { // click
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.frequency.value = isAccent ? 2000 : 1500;
                gain.gain.value = isAccent ? 0.3 : 0.15;
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.05);
            }
        }

        document.getElementById('bpm').addEventListener('input', (e) => {
            const bpm = e.target.value;
            document.getElementById('bpm-value').textContent = bpm;
            document.getElementById('bpm-display').textContent = bpm;
        });

        document.getElementById('time-sig').addEventListener('change', createBeatDisplay);

        document.getElementById('start-metronome').addEventListener('click', () => {
            initAudio();
            const btn = document.getElementById('start-metronome');

            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
                btn.textContent = 'Start';
                document.querySelectorAll('.beat-indicator').forEach(b => b.classList.remove('active'));
                currentBeat = 0;
            } else {
                const bpm = parseInt(document.getElementById('bpm').value);
                const interval = 60000 / bpm;
                const timeSig = document.getElementById('time-sig').value;
                const beats = parseInt(timeSig.split('/')[0]);

                btn.textContent = 'Stop';

                metronomeInterval = setInterval(() => {
                    document.querySelectorAll('.beat-indicator').forEach(b => b.classList.remove('active'));
                    const beatIndicators = document.querySelectorAll('.beat-indicator');
                    if (beatIndicators[currentBeat]) {
                        beatIndicators[currentBeat].classList.add('active');
                    }

                    playClick(currentBeat === 0);
                    currentBeat = (currentBeat + 1) % beats;
                }, interval);
            }
        });

        // ===== INTERVAL TRAINER =====
        const intervals = [
            { name: 'Unison', semitones: 0, easy: true },
            { name: 'Minor 2nd', semitones: 1, easy: true },
            { name: 'Major 2nd', semitones: 2, easy: true },
            { name: 'Minor 3rd', semitones: 3, easy: true },
            { name: 'Major 3rd', semitones: 4, easy: true },
            { name: 'Perfect 4th', semitones: 5, easy: true },
            { name: 'Tritone', semitones: 6, easy: false },
            { name: 'Perfect 5th', semitones: 7, easy: false },
            { name: 'Minor 6th', semitones: 8, easy: false },
            { name: 'Major 6th', semitones: 9, easy: false },
            { name: 'Minor 7th', semitones: 10, easy: false },
            { name: 'Major 7th', semitones: 11, easy: false },
            { name: 'Octave', semitones: 12, easy: false }
        ];

        let currentInterval = null;
        let score = 0;
        let total = 0;

        function createIntervalButtons() {
            const container = document.getElementById('interval-buttons');
            container.innerHTML = '';
            const difficulty = document.getElementById('difficulty').value;
            const availableIntervals = difficulty === 'easy' ?
                intervals.filter(i => i.easy) : intervals;

            availableIntervals.forEach(interval => {
                const btn = document.createElement('button');
                btn.className = 'interval-btn';
                btn.textContent = interval.name;
                btn.addEventListener('click', () => checkAnswer(interval.semitones, btn));
                container.appendChild(btn);
            });
        }

        function playNewInterval() {
            initAudio();
            const difficulty = document.getElementById('difficulty').value;
            const availableIntervals = difficulty === 'easy' ?
                intervals.filter(i => i.easy) : intervals;

            currentInterval = availableIntervals[Math.floor(Math.random() * availableIntervals.length)];

            const baseNote = 'C';
            const baseOctave = 4;
            const targetIndex = (pianoNotes.indexOf(baseNote) + currentInterval.semitones) % 12;
            const targetOctave = baseOctave + Math.floor((pianoNotes.indexOf(baseNote) + currentInterval.semitones) / 12);
            const targetNote = pianoNotes[targetIndex];

            playNote(baseNote, baseOctave, 0.8);
            setTimeout(() => playNote(targetNote, targetOctave, 0.8), 900);

            document.getElementById('feedback').textContent = '';
            document.querySelectorAll('.interval-btn').forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
            });
        }

        function checkAnswer(semitones, btn) {
            if (!currentInterval) return;

            total++;
            document.getElementById('total').textContent = total;

            if (semitones === currentInterval.semitones) {
                score++;
                document.getElementById('score').textContent = score;
                document.getElementById('feedback').textContent = 'Correct!';
                document.getElementById('feedback').style.color = '#4caf50';
                btn.classList.add('correct');
            } else {
                document.getElementById('feedback').textContent = `Incorrect. It was ${currentInterval.name}`;
                document.getElementById('feedback').style.color = '#f44336';
                btn.classList.add('incorrect');
                document.querySelectorAll('.interval-btn').forEach(b => {
                    if (b.textContent === currentInterval.name) {
                        b.classList.add('correct');
                    }
                });
            }

            setTimeout(() => playNewInterval(), 2000);
        }

        document.getElementById('play-interval').addEventListener('click', playNewInterval);
        document.getElementById('difficulty').addEventListener('change', () => {
            createIntervalButtons();
            currentInterval = null;
            document.getElementById('feedback').textContent = '';
        });

        // Initialize
        createPiano();
        createMiniPiano('chord-piano');
        createMiniPiano('scale-piano');
        createCircleOfFifths();
        createBeatDisplay();
        createIntervalButtons();
        updateChord();
        updateScale();
    </script>
</body>
</html>